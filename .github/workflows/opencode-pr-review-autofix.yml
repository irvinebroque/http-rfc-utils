name: opencode-pr-review-autofix

on:
  pull_request:
    types: [opened]

concurrency:
  group: opencode-pr-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  review-and-fix:
    if: >-
      github.event.pull_request.head.repo.full_name == github.repository &&
      (github.event.pull_request.user.login == 'github-actions[bot]' || github.event.pull_request.user.login == 'app/github-actions')
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Checkout PR head branch
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          persist-credentials: false

      - name: Get OpenCode version
        id: version
        run: |
          VERSION=$(curl -sf https://api.github.com/repos/anomalyco/opencode/releases/latest | grep -o '"tag_name": *"[^"]*"' | cut -d'"' -f4)
          echo "version=${VERSION:-latest}" >> "$GITHUB_OUTPUT"

      - name: Cache OpenCode CLI
        id: cache-opencode
        uses: actions/cache@v4
        with:
          path: ~/.opencode/bin
          key: opencode-${{ runner.os }}-${{ runner.arch }}-${{ steps.version.outputs.version }}

      - name: Install OpenCode CLI
        if: steps.cache-opencode.outputs.cache-hit != 'true'
        run: curl -fsSL https://opencode.ai/install | bash

      - name: Add OpenCode to PATH
        run: echo "$HOME/.opencode/bin" >> "$GITHUB_PATH"

      - name: Configure high thinking mode
        run: |
          mkdir -p "$HOME/.opencode"
          cat > "$HOME/.opencode/opencode.json" <<'EOF'
          {
            "$schema": "https://opencode.ai/config.json",
            "provider": {
              "openai": {
                "models": {
                  "gpt-5.2-codex": {
                    "options": {
                      "reasoningEffort": "high"
                    }
                  }
                }
              }
            }
          }
          EOF

      - name: Run OpenCode review and autofix
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GH_TOKEN: ${{ github.token }}
          MODEL: openai/gpt-5.2-codex
          PROMPT: |
            You are running on pull request #${{ github.event.pull_request.number }}.
            PR URL: ${{ github.event.pull_request.html_url }}
            PR title: ${{ github.event.pull_request.title }}
            PR body:
            ${{ github.event.pull_request.body || '(no PR body provided)' }}

            Run /review first.
            Use high thinking mode for this entire run.
            Prioritize standards-compliance review quality for the standard/spec being implemented (for example RFC, W3C, SemVer, or related normative references in this repo).
            Validate normative MUST/SHOULD behavior and implementation/test/doc alignment.

            After review findings are identified, implement fixes on this same branch:
            ${{ github.event.pull_request.head.ref }}

            Commit and push fixes to this same branch.
            Do not create a new branch.
            Do not open a new pull request.
        run: opencode github run
