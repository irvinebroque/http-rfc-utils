name: opencode-issues-debug

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: Issue number to run against
        required: true
        type: string
      model:
        description: Model in provider/model format
        required: false
        default: openai/gpt-5.2-codex
        type: string

concurrency:
  group: opencode-issues-debug-${{ github.event.inputs.issue_number }}
  cancel-in-progress: true

jobs:
  opencode-debug:
    if: github.actor == 'irvinebroque'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Get OpenCode version
        id: version
        run: |
          VERSION=$(curl -sf https://api.github.com/repos/anomalyco/opencode/releases/latest | grep -o '"tag_name": *"[^"]*"' | cut -d'"' -f4)
          echo "version=${VERSION:-latest}" >> "$GITHUB_OUTPUT"

      - name: Cache OpenCode CLI
        id: cache-opencode
        uses: actions/cache@v4
        with:
          path: ~/.opencode/bin
          key: opencode-${{ runner.os }}-${{ runner.arch }}-${{ steps.version.outputs.version }}

      - name: Install OpenCode CLI
        if: steps.cache-opencode.outputs.cache-hit != 'true'
        run: curl -fsSL https://opencode.ai/install | bash

      - name: Add OpenCode to PATH
        run: echo "$HOME/.opencode/bin" >> "$GITHUB_PATH"

      - name: Build prompt from issue
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          issue_json="$(gh api "repos/${{ github.repository }}/issues/${{ github.event.inputs.issue_number }}")"
          issue_title="$(jq -r '.title' <<<"$issue_json")"
          issue_url="$(jq -r '.html_url' <<<"$issue_json")"
          issue_body="$(jq -r '.body // "(no issue body provided)"' <<<"$issue_json")"

          delim="OPENCODE_PROMPT_$(date +%s)_$RANDOM"
          {
              echo "PROMPT<<$delim"
              echo "You are working on a newly opened GitHub issue and should treat the issue itself as the task prompt."
              echo
              echo "Repository: ${{ github.repository }}"
              echo "Issue number: #${{ github.event.inputs.issue_number }}"
              echo "Issue URL: $issue_url"
              echo "Issue title: $issue_title"
              echo "Issue body:"
              printf '%s\n' "$issue_body"
              echo
              echo "research deeply"
               echo "then write plan to markdown"
               echo "then review your plan and improve it"
               echo "then implement your plan"
               echo "then review your implementation and improve it"
               echo "when you are done commit and push and make a pull request"
               echo "the pull request description must include: Closes #${{ github.event.inputs.issue_number }}"
               echo "$delim"
           } >> "$GITHUB_ENV"

      - name: Run OpenCode with debug logging
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GH_TOKEN: ${{ github.token }}
          MODEL: ${{ github.event.inputs.model }}
          SHARE: 'false'
        run: opencode --print-logs --log-level DEBUG github run

      - name: Ensure created PR links issue
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          issue_number='${{ github.event.inputs.issue_number }}'
          current_branch="$(git branch --show-current)"
          pr_number="$(gh pr list --repo '${{ github.repository }}' --head "$current_branch" --json number --jq 'if length > 0 then .[0].number else "" end')"

          if [ -z "$pr_number" ]; then
            echo "No PR found for branch $current_branch; skipping issue link update."
            exit 0
          fi

          pr_body="$(gh pr view "$pr_number" --repo '${{ github.repository }}' --json body --jq .body)"
          if [[ "$pr_body" == *"#${issue_number}"* ]]; then
            echo "PR #$pr_number already references issue #$issue_number."
            exit 0
          fi

          updated_body="$pr_body"
          if [ -n "$updated_body" ]; then
            updated_body="$updated_body\n\nCloses #${issue_number}"
          else
            updated_body="Closes #${issue_number}"
          fi

          gh pr edit "$pr_number" --repo '${{ github.repository }}' --body "$updated_body"
          echo "Updated PR #$pr_number to include Closes #$issue_number."

      - name: Upload OpenCode logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: opencode-debug-logs-${{ github.run_id }}-${{ github.run_attempt }}
          path: ~/.local/share/opencode/log/
          if-no-files-found: warn
          retention-days: 7
