name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  changeset:
    name: Changeset
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Ensure changeset exists
        run: |
          BASE_REF="${{ github.event.pull_request.base.ref }}"
          git fetch origin "$BASE_REF" --depth=1

          has_changeset='false'
          while IFS= read -r file; do
            case "$file" in
              .changeset/*.md)
                if [ "$file" != '.changeset/README.md' ]; then
                  has_changeset='true'
                  break
                fi
                ;;
            esac
          done < <(git diff --name-only "origin/$BASE_REF"...HEAD)

          if [ "$has_changeset" != 'true' ]; then
            echo 'No changeset found in this PR. Add one with `pnpm changeset`.'
            exit 1
          fi

  api_semver:
    name: API and SemVer
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      actions: write
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22
          cache: pnpm

      - run: pnpm install --frozen-lockfile --ignore-scripts

      - name: Generate API extraction artifact
        run: pnpm api:extract

      - name: Enforce SemVer public API policy
        run: |
          mkdir -p temp/semver
          set +e
          pnpm exec tsx scripts/semver/check.ts --base-ref "origin/${{ github.event.pull_request.base.ref }}" --json > temp/semver/report.json
          semver_status=$?
          set -e

          if [ -f temp/semver/report.json ]; then
            cat temp/semver/report.json
          fi

          exit "$semver_status"

      - name: Upload SemVer report artifact
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: semver-report
          path: temp/semver/report.json
          if-no-files-found: warn

  structure:
    name: Structure
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22
          cache: pnpm

      - run: pnpm install --frozen-lockfile --ignore-scripts

      - name: Structure checks
        run: pnpm check:structure

  security:
    name: Security
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22
          cache: pnpm

      - run: pnpm install --frozen-lockfile --ignore-scripts

      - name: Security checks
        run: pnpm security:ci

  lint_type_aware:
    name: Lint (type-aware)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22
          cache: pnpm

      - run: pnpm install --frozen-lockfile --ignore-scripts

      - name: Type-aware lint checks
        run: pnpm lint:ci

  lint_autofix:
    name: Lint autofix (same-repo PR)
    if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          persist-credentials: true

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22
          cache: pnpm

      - run: pnpm install --frozen-lockfile --ignore-scripts

      - name: Apply safe type-aware lint fixes
        run: pnpm lint:type-aware:fix

      - name: Detect autofix changes
        id: detect_changes
        run: |
          if git diff --quiet; then
            echo 'has_changes=false' >> "$GITHUB_OUTPUT"
          else
            echo 'has_changes=true' >> "$GITHUB_OUTPUT"
          fi

      - name: Commit and push autofix changes
        if: steps.detect_changes.outputs.has_changes == 'true'
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email '41898282+github-actions[bot]@users.noreply.github.com'
          git add -A
          git commit -m 'chore(lint): apply safe type-aware oxlint fixes'
          git push

  lint_autofix_fork:
    name: Lint autofix (fork PR patch)
    if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name != github.repository
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      actions: write
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22
          cache: pnpm

      - run: pnpm install --frozen-lockfile --ignore-scripts

      - name: Apply safe type-aware lint fixes
        run: pnpm lint:type-aware:fix

      - name: Generate autofix patch
        id: generate_patch
        run: |
          git diff --binary > oxlint-autofix.patch
          if [ -s oxlint-autofix.patch ]; then
            echo 'has_patch=true' >> "$GITHUB_OUTPUT"
          else
            echo 'has_patch=false' >> "$GITHUB_OUTPUT"
          fi

      - name: Upload autofix patch artifact
        if: always() && steps.generate_patch.outputs.has_patch == 'true'
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: oxlint-autofix-patch
          path: oxlint-autofix.patch

      - name: Enforce type-aware lint after autofix
        run: pnpm lint:ci

  typecheck:
    name: Typecheck (${{ matrix.label }})
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        include:
          - label: all
            check: typecheck:all
          - label: strict
            check: typecheck:strict
          - label: lib
            check: typecheck:lib
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22
          cache: pnpm

      - run: pnpm install --frozen-lockfile --ignore-scripts

      - name: Run ${{ matrix.check }}
        run: pnpm ${{ matrix.check }}

  coverage:
    name: Run tests + audit coverage
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22
          cache: pnpm

      - run: pnpm install --frozen-lockfile --ignore-scripts

      - name: Test with coverage
        run: pnpm test:coverage

      - name: Coverage threshold checks
        run: pnpm test:coverage:check

  build:
    name: Build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22
          cache: pnpm

      - run: pnpm install --frozen-lockfile --ignore-scripts

      - name: Build
        run: pnpm build

  required-checks:
    name: Required checks
    if: always()
    needs:
      - changeset
      - api_semver
      - structure
      - security
      - lint_type_aware
      - typecheck
      - coverage
      - build
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Verify required job results
        run: |
          failures=0
          event_name='${{ github.event_name }}'

          allow_skipped='false'
          if [ "$event_name" != 'pull_request' ]; then
            allow_skipped='true'
          fi

          check_result() {
            local name="$1"
            local result="$2"
            local allow_skipped_for_job="$3"

            if [ "$result" = 'success' ]; then
              echo "$name: $result"
            elif [ "$result" = 'skipped' ] && [ "$allow_skipped_for_job" = 'true' ]; then
              echo "$name: $result"
            else
              echo "$name: $result"
              failures=1
            fi
          }

          check_result 'changeset' '${{ needs.changeset.result }}' "$allow_skipped"
          check_result 'api_semver' '${{ needs.api_semver.result }}' "$allow_skipped"
          check_result 'structure' '${{ needs.structure.result }}' 'false'
          check_result 'security' '${{ needs.security.result }}' 'false'
          check_result 'lint_type_aware' '${{ needs.lint_type_aware.result }}' 'false'
          check_result 'typecheck' '${{ needs.typecheck.result }}' 'false'
          check_result 'Run tests + audit coverage' '${{ needs.coverage.result }}' 'false'
          check_result 'build' '${{ needs.build.result }}' 'false'

          if [ "$failures" -ne 0 ]; then
            echo 'One or more required jobs failed.'
            exit 1
          fi
